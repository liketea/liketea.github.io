# 数据仓库
纵向分层、横向分域、空间换时间、隔离变更、保证数据一致性

有待整理称为精品，数仓记录世界、数科解释世界；

> Bill Inmon：数据仓库是一个面向主题的、集成的、随时间变化的、但信息本身相对稳定的数据集合，用于对管理决策过程的支持。
> Ralph Kimball：数据仓库是一个将源系统数据抽取、清洗、规格化、提交到维度数据存储的系统，为决策的制定提供查询和分析功能的支持与实现。

Inmon 的表述侧重于数据仓库的性质和特点，Kimball 的表述侧重于数据仓库建设的过程，综合而言，数据仓库是**通过 ETL 得到的、为管理决策提供支持的数据集合，具有面向主题、集成、随时间变化、信息相对稳定的特点**。

如果没有数据仓库，当管理者需要查询这些数据并以此指定相应决策时，就需要从生产库直接拉取，这可能会影响到生产业务，而且数据不可复用，因此需要有一个仓库存储数据实现联机分析处理（OLAP, Online Analytical Processing）。

## 数仓方法论
### 相关理论
如何有效组织数据是研究数据仓库的重点，不同的组织方式形成了关于数据仓库的不同建模理论：

|        | ER 模型        | 维度模型         |
|--------|--------------|--------------|
| 处理类型 | 联机事务处理（OLTP） | 联机分析处理（OLAP） |
| 设计目的   | 事务处理         | 数据分析         |
| 主要操作   | 增删改查         | 复杂查询         |
| 处理特点   | 高并发 小数据量  | 低并发 大数据量         |
| 典型形式   | 3NF          | 星型模型         |


#### ER 模型
ER 模型（Entity-Relationship Modeling）常用于联机事务处理过程(On-Line Transaction Processing, OLTP) 数据库建模，应用到构建数仓时更偏重数据整合，站在企业整体考虑，将各个系统的数据按相似性、一致性、合并处理，为数据分析、决策服务，但并不便于直接用来支持分析。缺陷：需要全面梳理企业所有的业务和数据流，周期长，人员要求高。

ER 模型是站在企业的角度从上往下按主题进行相似性组合和合并，并进行一致性处理，最经典的实践就是 Teradata 公司基于金融业务发布的FS-LDM（Finacial Services Logical Data Model），它将金融业务划分为 10 大主题，企业可基于这个模型快速落地自己的数据仓库。

![](https://likeitea-1257692904.cos.ap-guangzhou.myqcloud.com/liketea_blog/xx0317.png)

#### 维度模型
维度建模（Dimensional Modeling）是面向分析场景构建数仓模型；重点关注快速、灵活地解决分析需求，同时能够提供大规模数据的快速响应性能。针对性强，主要应用于数据仓库构建和 OLAP 引擎底层数据模型。优点：不需要完整的梳理企业业务流程和数据，实施周期根据主题边界而定，容易快速实现 demo，而且相对来说便于理解、提高查询性能、对称并易扩展。

维度模型更侧重于完成具体的分析决策需求，是一种从下往上的构建思路。同时，它关注大规模复杂查询的响应性能，星型模型、雪花模型是其典型形式。

![](https://likeitea-1257692904.cos.ap-guangzhou.myqcloud.com/liketea_blog/xxmx0317.png)

![](https://likeitea-1257692904.cos.ap-guangzhou.myqcloud.com/liketea_blog/xh03171211.png)

本文接下来的内容都是围绕维度建模来展开。

### 基本概念
数据仓库本质上是对现实世界的记录和描述，而要描述这个世界，我们通常只需要回答“是什么”和“发生了什么”这两个问题，与之相对应的，维度表是在回答“是什么”的问题，而事实表是在回答“发生了什么”的问题：

- 维度：指的是**事件环境**，比如所处的城市、小区、公司、部门，商品所归属的一级大类、二级大类等。更通俗地理解是，维度指的是 where 和 by 后面跟着的字段，用来查询约束、分类汇总和排序。
- 事实：指的是**事件度量**，比如商品数量、成交金额、利润率等，度量业务过程的事实，一般为整型或浮点型的十进制数值，可分为可加、半可加和不可加三种类型。可加的事实指能够以任意维度直接汇总；半可加事实只能以特定维度汇总，如房屋面积可以按小区汇总，但不能按时间汇总，因为今天的房屋面积加昨天的房屋面积是没有意义的；不可加事实不具有可加性，如比率型事实，在任何维度下利润率加利润率都不具有实际含义。
- 维度表：维度表又称维表，维表存储的一般是对事实描述的信息，每一张维表对应现实世界中的一个对象或者概念。例如：用户、商品、日期、地区等。

![](https://likeitea-1257692904.cos.ap-guangzhou.myqcloud.com/liketea_blog/xx03071144.png)

- 事实表：发生在现实世界中的操作型事件，其所产生的可度量数值，存储在事实表中。事实表主要围绕业务过程设计，表中的每行数据代表一个业务**可度量事件**（下单、支付、退款、评价等）。每一个事实表的行包括：具有可加性的数值型的度量值、与维表相连接的外键。通常具有两个和两个以上的外键，外键之间表示维表之间多对多的关系。就应用场景而言，事实表主要包括如下三种类型：
    - 事务事实表：用于描述业务过程，按业务过程的单一性或多业务过程可进一步分为单事务事实表和多事务事实表。其中单事务事实表分别记录每个业务过程，如下单业务记入下单事实表，支付业务记入支付事实表。多事务事实表在同一个表中包含了不同业务过程，如下单、支付、签收等业务过程记录在一张表中，通过新增字段来判断属于哪一个业务过程。
    - 周期快照事实表：在一个确定的时间间隔内对业务状态进行度量，如用户每月使用信用卡的消费情况。
    - 累计快照事实表：用于查看不同事件之间的时间间隔，例如分析用户从购买到支付的市场、从下单到订单完结的时长等，一般适用于有明确时间间隔的业务过程。

![](https://likeitea-1257692904.cos.ap-guangzhou.myqcloud.com/liketea_blog/xxx03071145.png)

### 维度建模的三种模式

- 星型模式(Star Schema)：是最常用的维度建模方式，星形模式的维度建模由一个事实表和一组维表成，且具有以下特点：
    - 维表只和事实表关联，维表之间没有关联；
    - 每个维表主键为单列，且该主键放置在事实表中，作为两边连接的外键；
    - 以事实表为核心，维度表围绕核心呈星形分布；

![](https://likeitea-1257692904.cos.ap-guangzhou.myqcloud.com/liketea_blog/sc0317115911.jpg)

- 雪花模式(Snowflake Schema)是对星型模式的扩展。雪花模式的维度表可以拥有其他维度表的外键，虽然这种模型相比星型更规范一些，但是由于这种模型不太容易理解，**维护成本**比较高，而且**性能**方面需要关联多层维表，性能也比星型模型要低。所以一般不是很常用。

![](https://likeitea-1257692904.cos.ap-guangzhou.myqcloud.com/liketea_blog/sc0317120511.jpg)

- 星座模式是星型模式延伸而来，星型模式是基于一张事实表的，而星座模式是基于多张事实表的，而且共享维度信息。在业务发展后期，绝大部分维度建模都采用的是星座模式。

![](https://likeitea-1257692904.cos.ap-guangzhou.myqcloud.com/liketea_blog/sdadasvs241.png)


## 数仓架构
纵向分层、横向分域：

1. 把所有公共逻辑封装到了 DWD 层，以隔离上层逻辑变更，降低维护成本；
2. 在 DWS 层进行维度建模，关联清洗好的各种维度，并做相应聚合；
3. 最后在 ADS 层面向报表应用进行数据开发；

![](https://likeitea-1257692904.cos.ap-guangzhou.myqcloud.com/liketea_blog/20210317123432.png)

## 参考
- [黄聪：OLAP与OLTP介绍](https://www.cnblogs.com/huangcong/archive/2010/05/07/1729358.html)
- [由数据仓库模型雪花模型 VS 星型模型哪个更好引起的血腥风雨](https://ask.hellobi.com/blog/tianshansoft/2061)
- [浅谈银行数据仓库：金融主题层建设篇](https://www.infoq.cn/article/gsmwfqq7kjsg0k9adwqr)



